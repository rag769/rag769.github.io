$(function(){(()=>{if($("#extras_ro_card_enchant_select_box").length>0)return;const e={datasets:[{label:"",data:[]}]};let t=null;$.getScript("https://cdn.jsdelivr.net/npm/chart.js",()=>{$.getScript("https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns",()=>{$("#trade_log").before('<canvas id="trade_scatter"></canvas>'),t=new Chart(document.getElementById("trade_scatter").getContext("2d"),{type:"scatter",data:e,options:{scales:{x:{type:"time",time:{unit:"day",tooltipFormat:"yyyy-MM-dd HH:mm",displayFormats:{day:"yyyy-MM-dd"}},title:{display:!0,text:"日時"}},y:{title:{display:!0,text:"単価"}}},plugins:{legend:{display:!1}}}}),o()})});const a=["カード","アクエリアス","アリエス","ヴァルゴ","ヴァルゴの欠片","カプリコーン","キャンサー","サーペンタリウス","サジタリウス","ジェミニ","スコーピオ","タウロス","パイシーズ","リーブラ","レオ","レオの欠片","覇者の思念","魔神の幸運","魔神の集中","魔神の迅速","魔神の体力","魔神の知力","魔神の腕力"],n=()=>{const e=new Set,t=new Set,n=$(".conent-ttl").text();$("#Normal_Coefficient > table > tbody > tr:not([style*='display: none']) > td:first-child > div").each((r,o)=>{-1==$(o).text().indexOf(n)&&(a.find(e=>$(o).text().indexOf(e)>=0)?e.add($(o).text()):t.add($(o).text()))});const r=(e,t)=>(e=String(e).replace("%","").split("+"),t=String(t).replace("%","").split("+"),1==e.length||1==t.length||e[0]!=t[0]?e[0]<t[0]?-1:1:e[1]-t[1]);return[Array.from(e).sort(r),Array.from(t).sort(r)]},r=()=>{let e,t;[e,t]=n(),$("#extras_ro_card_enchant_select_box").remove(),e.length+t.length>0&&$(".card_flg:last").parent().after('<div id="extras_ro_card_enchant_select_box"><h4>フィルタ</h4></div>'),e.length>0&&($("#extras_ro_card_enchant_select_box").append('<select id="extras_ro_card_select" style="width:20em;color:#666;padding: 0.4em 1em; border-radius: 20px;border:1px solid;background:#fff"><option value="">カード指定なし</option><option value="nocard">カードなし</option></select>'),e.forEach(e=>{$("#extras_ro_card_select").append($("<option>").val(e).text(e))})),t.length>0&&($("#extras_ro_card_enchant_select_box").append('<select id="extras_ro_enchant_select" style="width:20em;color:#666;margin-left:0.5em;padding: 0.4em 1em; border-radius: 20px;border:1px solid;background:#fff"><option value="">エンチャント指定なし</option></select>'),t.forEach(e=>{$("#extras_ro_enchant_select").append($("<option>").val(e).text(e))}))},o=()=>{const e=$("#extras_ro_card_select").val()||"",n=$("#extras_ro_enchant_select").val()||"",r=[],o=[];$("#Normal_Coefficient > table > tbody > tr").each((t,i)=>{let c="nocard"==e,l=!1;if($("td:first-child > div",i).each((t,r)=>{c="nocard"==e?c&&!a.find(e=>$(r).text().indexOf(e)>=0):c||$(r).text().indexOf(e)>=0,l=l||$(r).text().indexOf(n)>=0}),c&&l){$(i).show(),$($("#Noatun_Coefficient > table > tbody > tr")[t]).show();$("td",i);r.push(parseInt($($("td",i)[1]).text().replaceAll(",","").replace("zeny","")));const e={x:"",y:0};e.y=parseInt($($("td",i)[1]).text().replaceAll(",","").replace("zeny","")),e.x=new Date($($("td",i)[3]).text().replace(" ","T")),o.push(e)}else $(i).hide(),$($("#Noatun_Coefficient > table > tbody > tr")[t]).hide()}),r.length?(r.sort((e,t)=>e-t),half=(r.length%2?r.length-1:r.length)/2,$("#Normal_Coefficient_Summary .median_price .money").text(`${r[half].toLocaleString()}zeny`),$("#Normal_Coefficient_Summary .min_price .money").text(`${r[0].toLocaleString()}zeny`),$("#Normal_Coefficient_Summary .max_price .money").text(`${r[r.length-1].toLocaleString()}zeny`),$("#Noatun_Coefficient_Summary .median_price .money").text(`${Math.ceil(r[half]/1e3).toLocaleString()}zeny`),$("#Noatun_Coefficient_Summary .min_price .money").text(`${Math.ceil(r[0]/1e3).toLocaleString()}zeny`),$("#Noatun_Coefficient_Summary .max_price .money").text(`${Math.ceil(r[r.length-1]/1e3).toLocaleString()}zeny`)):($("#Normal_Coefficient_Summary .median_price .money").text("N/A"),$("#Normal_Coefficient_Summary .min_price .money").text("N/A"),$("#Normal_Coefficient_Summary .max_price .money").text("N/A"),$("#Noatun_Coefficient_Summary .median_price .money").text("N/A"),$("#Noatun_Coefficient_Summary .min_price .money").text("N/A"),$("#Noatun_Coefficient_Summary .max_price .money").text("N/A")),t&&(t.data.datasets[0].data=o,t.update())};$(document).on("change","#extras_ro_card_select,#extras_ro_enchant_select",o);const i=()=>{0==$("#trade_log>*:first").length||$("#trade_log>*:first").data("loading")?setTimeout(i,100):(r(),o())};$(".item_filter input[type=checkbox]").click(()=>{$("#trade_log>*:first").data("loading","loading"),i()}),i()})()});